<script>
  const form = document.getElementById('exchangeForm');
  const messageEl = document.getElementById('message');

  let currentRate = 0;

  // –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å USDT –∫ RUB –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º 1 —Ä—É–±–ª—å
  async function fetchRate() {
    try {
      const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=rub');
      const data = await res.json();
      currentRate = data.tether.rub + 1; // +1 —Ä—É–±–ª—å
      document.getElementById('rateDisplay').innerHTML = `
        üí± <strong>–ö—É—Ä—Å –ø–æ–∫—É–ø–∫–∏ USDT:</strong> ${currentRate.toFixed(2)} ‚ÇΩ
      `;
    } catch (err) {
      document.getElementById('rateDisplay').innerHTML = '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å';
    }
  }

  fetchRate(); // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

  // –ü—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç RUB
  form.amount.addEventListener('input', () => {
    const amount = parseFloat(form.amount.value);
    if (!isNaN(amount) && currentRate > 0) {
      const total = (amount * currentRate).toFixed(2);
      document.getElementById('totalDisplay').innerHTML = `üí∞ <strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong> ${total} ‚ÇΩ`;
    } else {
      document.getElementById('totalDisplay').innerHTML = '';
    }
  });

  form.addEventListener('submit', e => {
    e.preventDefault();

    const amount = form.amount.value.trim();
    const wallet = form.wallet.value.trim();
    const phone = form.phone.value.trim();
    const operation = form.operation.value;

    const phonePattern = /^\+?\d{10,15}$/;
    if (!phonePattern.test(phone)) {
      messageEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7xxxxxxxxxx';
      messageEl.style.color = 'red';
      return;
    }

    const payload = {
      operation,
      amount,
      wallet,
      phone,
      rubTotal: (parseFloat(amount) * currentRate).toFixed(2),
      rateUsed: currentRate.toFixed(2)
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram WebApp
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.sendData(JSON.stringify(payload));
    }

    messageEl.style.color = '#0a2e63';
    messageEl.textContent = '–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞, —Å –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';
    form.reset();
    document.getElementById('totalDisplay').innerHTML = '';
  });
</script>
